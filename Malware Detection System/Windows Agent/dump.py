import os
import time
import requests
from datetime import datetime

FOG_URL = "http://localhost:5000/"

# Function to delete files
def remove_file(filename):
    cmd = "rm " + filename
    os.system(cmd)

# Function to export current memory dump and returns dump file name 
def export_dump():
    # The file name will be the datetime from the memory dump
    current_datetime = datetime.now().strftime("%Y%m%d%H%M%S")
    
    # Exporting the memory dump
    cmd = "lib/DumpIt.exe /Q /N /O " + current_datetime
    os.system(cmd)
    
    # Wait to create the dump
    time.sleep(60)
    
    #  Compress the memory dump
    cmd = "tar -acf " + current_datetime  + ".tar " + current_datetime
    os.system(cmd)
    
    # Wait to compress the file
    time.sleep(60)
    
    # Delete original dump and keep the compressed file
    remove_file(current_datetime)

    return current_datetime + ".tar"

# Function to request the memory dump analysis    
def request_mem_analysis(dump_path):
    url = FOG_URL
    json_obj = {'dump' : dump_path}
    
    req  = requests.post(url, json_obj)
    
    # Wait to fog to collect the dump
    sleep(900)
    remove_file(dump_path)


# Export dump   
export_name = export_dump()
export_path = os.getcwd() + "/" + export_name

# Request dump analysis
request_mem_analysis(export_path)